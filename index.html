<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Password Reset - Redirecting...</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      text-align: center;
      padding: 2rem;
      max-width: 800px;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    h2 {
      margin: 0 0 0.5rem;
      font-size: 1.75rem;
    }
    p {
      margin: 0 0 2rem;
      opacity: 0.9;
      font-size: 1.1rem;
    }
    .debug {
      margin-top: 2rem;
      padding: 1rem;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      font-size: 0.875rem;
      text-align: left;
      font-family: 'Courier New', monospace;
      max-height: 400px;
      overflow-y: auto;
    }
    .debug p {
      margin: 0.25rem 0;
      font-size: 0.875rem;
    }
    .error {
      color: #ff6b6b;
      background: rgba(255,107,107,0.2);
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.5rem 0;
    }
    .success {
      color: #51cf66;
    }
    .warning {
      color: #ffd43b;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <h2>Setting Up Password Reset</h2>
    <p>Please wait while we redirect you securely...</p>
    <div class="debug" id="debug"></div>
  </div>

  <script>
    // ========================================================================
    // PASSWORD RESET REDIRECT HANDLER
    // 
    // PURPOSE: Convert Supabase hash fragment tokens ‚Üí query parameters
    // REASON: Figma.site hosting strips hash fragments from URLs
    // 
    // HOW TO USE:
    // 1. Host this file on any static hosting (GitHub Pages, Netlify, etc.)
    // 2. Set that URL as Supabase "Site URL" in dashboard
    // 3. Email links will come here, we'll redirect to Figma.site with tokens
    // ========================================================================

    const debug = document.getElementById('debug');
    const FIGMA_SITE_URL = 'https://electrician-exam-5640.figma.site';
    
    function log(message, type = 'info') {
      console.log(message);
      const p = document.createElement('p');
      p.textContent = message;
      if (type === 'error') p.className = 'error';
      if (type === 'success') p.className = 'success';
      if (type === 'warning') p.className = 'warning';
      debug.appendChild(p);
      
      // Auto-scroll to bottom
      debug.scrollTop = debug.scrollHeight;
    }

    try {
      log('üîÑ Auth Redirect Handler - v1.0', 'success');
      log('üìç Current URL: ' + window.location.href);
      log('üéØ Target site: ' + FIGMA_SITE_URL);
      log('');
      
      // ======================================================================
      // STEP 1: Read Hash Fragment
      // ======================================================================
      
      const hash = window.location.hash;
      log('üìã Reading hash fragment...');
      
      if (!hash || hash.length <= 1) {
        log('‚ö†Ô∏è No hash fragment found!', 'warning');
        
        // Check if tokens already in query params
        const search = window.location.search;
        log('üîç Checking query params instead...');
        
        if (search && search.includes('access_token')) {
          log('‚úÖ Tokens found in query params (unusual but ok)', 'success');
          const redirectUrl = FIGMA_SITE_URL + '/' + search;
          log('üöÄ Redirecting to: ' + redirectUrl);
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 1500);
          return;
        }
        
        // No tokens anywhere
        log('‚ùå No authentication tokens found', 'error');
        log('üí° This might be an error or expired link', 'error');
        log('üîÑ Redirecting to main site in 5 seconds...', 'warning');
        
        setTimeout(() => {
          window.location.href = FIGMA_SITE_URL;
        }, 5000);
        return;
      }
      
      log('‚úÖ Hash fragment found: ' + hash.substring(0, 50) + '...', 'success');
      log('');
      
      // ======================================================================
      // STEP 2: Parse Hash Parameters
      // ======================================================================
      
      log('üîë Parsing parameters from hash...');
      const hashParams = new URLSearchParams(hash.slice(1));
      
      // Extract all parameters
      const params = {};
      let hasAccessToken = false;
      let hasRefreshToken = false;
      let tokenType = null;
      
      for (const [key, value] of hashParams) {
        params[key] = value;
        
        // Display value (truncate tokens for security)
        let displayValue = value;
        if ((key.includes('token') || key.includes('Token')) && value.length > 25) {
          displayValue = value.substring(0, 25) + '... (' + value.length + ' chars)';
        }
        
        log('   ‚úì ' + key + ': ' + displayValue);
        
        // Track important parameters
        if (key === 'access_token' && value) hasAccessToken = true;
        if (key === 'refresh_token' && value) hasRefreshToken = true;
        if (key === 'type') tokenType = value;
      }
      
      log('');
      
      // ======================================================================
      // STEP 3: Validate Parameters
      // ======================================================================
      
      log('üîç Validating parameters...');
      
      if (!hasAccessToken) {
        log('‚ùå Missing access_token - cannot proceed', 'error');
      } else {
        log('‚úÖ access_token: present', 'success');
      }
      
      if (!hasRefreshToken) {
        log('‚ö†Ô∏è Missing refresh_token - might cause issues', 'warning');
      } else {
        log('‚úÖ refresh_token: present', 'success');
      }
      
      if (!tokenType) {
        log('‚ö†Ô∏è Missing type parameter', 'warning');
      } else if (tokenType === 'recovery') {
        log('‚úÖ type: recovery (password reset)', 'success');
      } else {
        log('‚ö†Ô∏è type: ' + tokenType + ' (expected "recovery")', 'warning');
      }
      
      // Check for errors
      if (params.error) {
        log('‚ùå Error in URL: ' + params.error, 'error');
        if (params.error_description) {
          log('   Description: ' + params.error_description, 'error');
        }
      }
      
      log('');
      
      // ======================================================================
      // STEP 4: Build Query String
      // ======================================================================
      
      log('üîß Converting hash ‚Üí query parameters...');
      
      const queryParams = new URLSearchParams();
      for (const [key, value] of Object.entries(params)) {
        queryParams.set(key, value);
      }
      
      const queryString = queryParams.toString();
      log('‚úÖ Query string built (' + queryString.length + ' chars)', 'success');
      log('');
      
      // ======================================================================
      // STEP 5: Redirect to Figma Site
      // ======================================================================
      
      const redirectUrl = FIGMA_SITE_URL + '/?' + queryString;
      
      log('üéØ Final redirect URL:');
      log('   ' + FIGMA_SITE_URL + '/?');
      log('   ' + queryString.substring(0, 80) + '...');
      log('');
      
      log('‚úÖ All checks passed!', 'success');
      log('üöÄ Redirecting in 1 second...', 'success');
      
      // Redirect after brief delay (allows user to see status)
      setTimeout(() => {
        window.location.href = redirectUrl;
      }, 1000);
      
    } catch (error) {
      log('');
      log('‚ùå CRITICAL ERROR: ' + error.message, 'error');
      log('Stack: ' + error.stack, 'error');
      log('');
      log('üí° Redirecting to main site in 5 seconds...', 'warning');
      
      setTimeout(() => {
        window.location.href = FIGMA_SITE_URL;
      }, 5000);
    }
  </script>
</body>
</html>
